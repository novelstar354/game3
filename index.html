<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
 <link rel="icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQoZ5nF2nh3MGMh1FdK-P-WiE6f-TJUeZJDI1QVThw-Ew&s=10" sizes="16×16" type="image/png" />   
<title>ブロックシューティング</title>
<style>
  :root{ --bg:#071021; --panel:#0b1220; --accent:#39f; --danger:#ff5b5b; }
  html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg),#021026);color:#eef;font-family:Inter, 'Noto Sans JP', sans-serif;-webkit-font-smoothing:antialiased;}
  .wrap{max-width:980px;margin:18px auto;padding:12px;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;font-size:18px}
  button{background:var(--accent);color:#012;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#eef}
  canvas{width:100%;height:64vh;border-radius:12px;background:#00131a;display:block}
  .hud{display:flex;justify-content:space-between;margin-top:8px;font-size:14px}
  .controls{display:flex;gap:8px;align-items:center}
  .touch-controls{display:flex;justify-content:center;gap:14px;margin-top:10px}
  .touch-btn{background:#ffffff14;padding:12px 16px;border-radius:10px;user-select:none}
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6)}
  .panel{background:linear-gradient(180deg,#061226,#081523);padding:18px;border-radius:12px;max-width:720px;width:94%;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  .row{display:flex;gap:8px;align-items:center;margin-top:8px}
  label{font-size:14px}
   select,input[type=range]{width:100%}
     footer {
           padding: 30px;
           text-align: center;
           font-size: 0.85rem;
           color: rgba(255,255,255,0.5);
           border-top: 1px solid rgba(255,255,255,0.1);
           margin-top: 60px;
  }
  @media(min-width:768px){ .touch-controls{display:none} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ブロックシューティング</h1>
    <div class="controls">
      <button id="resumeBtn" class="ghost">戻る</button>
      <button id="startBtn">スタート</button>
      <button id="restartBtn">リスタート</button>
    </div>
  </header>

  <canvas id="game"></canvas>

  <div class="hud">
    <div>スコア: <span id="score">0</span></div>
    <div>ライフ: <span id="life">3</span></div>
    <div>ステージ: <span id="stage">1</span> / <span id="maxStage">3</span></div>
    <div>レベル: <span id="level">1</span></div>
  </div>

  <div class="touch-controls">
    <div class="touch-btn" id="leftBtn">◀</div>
    <div class="touch-btn" id="fireBtn">●</div>
    <div class="touch-btn" id="rightBtn">▶</div>
  </div>

</div>

   <footer>
       © 2025 STAR CORPORATION - All Rights Reserved.
   </footer>


<!-- Title / Settings overlay -->
<div id="titleOverlay" class="overlay">
  <div class="panel">
    <h2>ブロックシューティング — タイトル</h2>
    <p>操作: ← → / スペース発射 / Pでポーズ。スマホは下のボタン。</p>
    <div class="row">
      <label>難易度：</label>
      <select id="difficulty">
        <option value="easy">やさしい</option>
        <option value="normal" selected>ふつう</option>
        <option value="hard">むずかしい</option>
      </select>
    </div>
    <div class="row">
      <label>自機スキン：</label>
      <select id="skinSelect">
        <option value="default">ブルー（標準）</option>
        <option value="red">レッド</option>
        <option value="green">グリーン</option>
      </select>
    </div>
    <div class="row">
      <label>BGM 音量</label>
      <input id="bgmVol" type="range" min="0" max="1" step="0.01" value="0.6">
    </div>
    <div class="row">
      <label>SE 音量</label>
      <input id="seVol" type="range" min="0" max="1" step="0.01" value="0.9">
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="openSaved">ロード</button>
      <button id="saveBtn">セーブ</button>
      <button id="closeTitle">閉じる</button>
    </div>
  </div>
</div>

<!-- Stage Clear / Game Over -->
<div id="messageOverlay" class="overlay" style="display:none;align-items:flex-start;">
  <div class="panel" id="messagePanel">
    <h2 id="messageTitle">ステージクリア！</h2>
    <p id="messageText">...</p>
    <div style="text-align:right;margin-top:12px">
      <button id="nextBtn">次へ</button>
      <button id="retryBtn">やり直す</button>
      <button id="toTitleBtn">タイトルへ</button>
    </div>
  </div>
</div>

<script>
(()=>{
  // --- canvas setup ---
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  function fit(){
    const r = devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * r;
    canvas.height = rect.height * r;
    ctx.setTransform(r,0,0,r,0,0);
  }
  window.addEventListener('resize', fit);
  // set initial size after layout
  setTimeout(fit,50);

  // --- audio (WebAudio) ---
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audioCtx = new AudioCtx();
  let bgmGain = audioCtx.createGain();
  let seGain = audioCtx.createGain();
  bgmGain.connect(audioCtx.destination); seGain.connect(audioCtx.destination);
  bgmGain.gain.value = 0.6; seGain.gain.value = 0.9;

  let bgmOsc = null;
  function playBGM(){
    if(bgmOsc) return;
    bgmOsc = audioCtx.createOscillator();
    bgmOsc.type = 'sine';
    bgmOsc.frequency.value = 110;
    const lfo = audioCtx.createOscillator();
    lfo.frequency.value = 0.2;
    const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 40;
    lfo.connect(lfoGain);
    lfoGain.connect(bgmOsc.frequency);
    bgmOsc.connect(bgmGain);
    lfo.start(); bgmOsc.start();
  }
  function stopBGM(){ if(bgmOsc){ bgmOsc.stop(); bgmOsc.disconnect(); bgmOsc=null; } }

  function playSE(type){
    const now = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(seGain);
    if(type==='shot'){ o.type='square'; o.frequency.setValueAtTime(800,now); }
    if(type==='expl'){ o.type='sawtooth'; o.frequency.setValueAtTime(120,now); }
    if(type==='hit'){ o.type='triangle'; o.frequency.setValueAtTime(200,now); }
    g.gain.setValueAtTime(0.2,now); g.gain.exponentialRampToValueAtTime(0.001, now+0.2);
    o.start(now); o.stop(now+0.25);
  }

  // --- game state ---
  let running=false, paused=false;
  let last=0;
  let score=0, life=3, level=1, stage=1, maxStage=3;
  let difficulty='normal';
  let skin='default';

  const bullets=[]; const enemies=[]; const enemyBullets=[]; const lasers=[]; const explosions=[];
  const player = { x:0, y:0, w:40, h:28, speed:260, cooldown:0 };
  const keys = {left:false, right:false, fire:false};

  // save/load
  function saveGame(){
    const data = {score, life, level, stage, difficulty, skin};
    localStorage.setItem('block_shooter_save', JSON.stringify(data));
    alert('セーブしました');
  }
  function loadGame(){
    const s = localStorage.getItem('block_shooter_save');
    if(!s){ alert('セーブが見つかりません'); return; }
    const d = JSON.parse(s);
    score = d.score||0; life = d.life||3; level=d.level||1; stage=d.stage||1; difficulty=d.difficulty||'normal'; skin=d.skin||'default';
    document.getElementById('difficulty').value = difficulty; document.getElementById('skinSelect').value = skin;
    updateHUD();
    alert('ロードしました');
  }

  // start/reset
  function resetGame(){
    bullets.length=0; enemies.length=0; enemyBullets.length=0; lasers.length=0; explosions.length=0;
    score=0; life=3; level=1; stage=1;
    placePlayer(); updateHUD();
  }
  function placePlayer(){ const r = devicePixelRatio||1; player.x = canvas.width/r/2 - player.w/2; player.y = canvas.height/r - 70; }

  // difficulty multipliers
  function diffMultiplier(){ if(difficulty==='easy') return 0.7; if(difficulty==='hard') return 1.4; return 1; }

  // enemy spawn
  function spawnEnemy(){
    const r = devicePixelRatio||1;
    const w = 28 + Math.random()*36;
    const typeRand = Math.random();
    let type = 'normal';
    if(typeRand>0.85) type='big'; else if(typeRand>0.5) type='mid'; else type='small';
    const baseHp = (type==='small')?1:(type==='mid')?2:4;
    const sp = (type==='small')?120: (type==='mid')?80:40;
    enemies.push({ x: Math.random()*(canvas.width/r - w - 10)+5, y:-50, w, h:w*0.6, type, hp: Math.ceil(baseHp*diffMultiplier()), speed: sp*diffMultiplier(), fireCd: 1.0 + Math.random()*2 });
  }

  function spawnBoss(){ const r = devicePixelRatio||1; enemies.push({ x:r*0+60, y:-200, w:220, h:120, speed:40, hp:120 + stage*80, type:'boss', fireCd:1.2, laserCd:4 }); }

  // explosions
  function spawnExplosion(x,y,w=40,h=40){ explosions.push({x,y,w,h,frame:0,max:16}); playSE('expl'); }

  // update HUD
  function updateHUD(){ document.getElementById('score').textContent = score; document.getElementById('life').textContent = life; document.getElementById('level').textContent = level; document.getElementById('stage').textContent = stage; document.getElementById('maxStage').textContent = maxStage; }

  // game update loop
  let spawnTimer = 0; function update(dt){
    if(paused) return;
    // player
    if(keys.left) player.x -= player.speed*dt; if(keys.right) player.x += player.speed*dt;
    const r = devicePixelRatio||1; player.x = Math.max(0, Math.min(canvas.width/r - player.w, player.x));
    if(player.cooldown>0) player.cooldown -= dt;
    if(keys.fire && player.cooldown<=0){ bullets.push({ x:player.x+player.w/2-4, y:player.y-12, w:8, h:12, speed:520 }); player.cooldown = 0.2; playSE('shot'); }

    // bullets
    bullets.forEach((b,i)=>{ b.y -= b.speed*dt; if(b.y < -30) bullets.splice(i,1); });

    // spawn enemies depending on difficulty and stage
    spawnTimer -= dt;
    if(spawnTimer <= 0){ spawnTimer = 0.6 / diffMultiplier(); if(Math.random()<0.9) spawnEnemy(); }
    if(score>200*stage && !enemies.some(e=>e.type==='boss')) spawnBoss();

    // enemies
    enemies.forEach((e,ei)=>{
      // move
      if(e.type==='boss'){
        e.y += e.speed*dt; if(e.y>30) e.y = 30; // boss enters then hover
        e.x += Math.sin(Date.now()*0.001 + ei)*0.6; // wobble
      } else {
        e.y += e.speed*dt;
      }

      // enemy fire
      e.fireCd -= dt;
      if(e.fireCd <= 0){
        // different patterns
        if(e.type==='small'){ enemyBullets.push({ x:e.x+e.w/2-3, y:e.y+e.h, w:6, h:10, speed:260 }); }
        else if(e.type==='mid'){ enemyBullets.push({ x:e.x+e.w/2-4, y:e.y+e.h, w:8, h:12, speed:200 }); }
        else if(e.type==='big'){ // spread
          for(let k=-1;k<=1;k++) enemyBullets.push({ x:e.x+e.w/2-4 + k*10, y:e.y+e.h, w:8, h:12, speed:160 + Math.abs(k)*40 });
        }
        else if(e.type==='boss'){ // boss fires targeted shots
          const dx = (player.x + player.w/2) - (e.x + e.w/2);
          const dy = (player.y) - (e.y + e.h);
          const angle = Math.atan2(dy, dx);
          const speed = 260;
          enemyBullets.push({ x:e.x+e.w/2-6, y:e.y+e.h-10, w:10, h:12, vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed, speed:null });
        }
        e.fireCd = (e.type==='boss')? 0.8 : 1.2 + Math.random()*1.6;
      }

      // boss laser
      if(e.type==='boss'){
        e.laserCd -= dt; if(e.laserCd<=0){ lasers.push({ x: e.x + e.w/2 - 4, y: e.y+e.h, width:6, height: canvas.height, life:1.2 }); e.laserCd = 6; }
      }

      // collision with player
      if(coll(e, player)){
        enemies.splice(ei,1); spawnExplosion(player.x, player.y, player.w, player.h); life--; updateHUD(); if(life<=0) gameOver();
      }
    });

    // bullet hits
    enemies.forEach((e,ei)=>{
      bullets.forEach((b,bi)=>{
        if(coll(b,e)){
          bullets.splice(bi,1); e.hp--; playSE('hit');
          if(e.hp<=0){ spawnExplosion(e.x,e.y,e.w,e.h); score += (e.type==='boss')? 300 : (e.type==='big'? 30 : 10); enemies.splice(ei,1); updateHUD(); }
        }
      });
    });

    // enemy bullets movement
    enemyBullets.forEach((b,i)=>{
      if(b.vx!=null){ b.x += b.vx*dt; b.y += b.vy*dt; }
      else b.y += b.speed*dt;
      if(b.y > canvas.height) enemyBullets.splice(i,1);
      else if(coll(b, player)) { enemyBullets.splice(i,1); spawnExplosion(player.x, player.y, player.w, player.h); life--; updateHUD(); if(life<=0) gameOver(); }
    });

    // lasers
    lasers.forEach((l,i)=>{
      l.life -= dt; if(life<=0){} // nothing
      if(coll(l, player)) { spawnExplosion(player.x, player.y, player.w, player.h); life--; updateHUD(); if(life<=0) gameOver(); }
      if(l.life <= 0) lasers.splice(i,1);
    });

    // explosions anim
    explosions.forEach((ex,i)=>{ ex.frame++; if(ex.frame>ex.max) explosions.splice(i,1); });

    // level & stage up
    level = Math.min(5, 1 + Math.floor(score/150));
    if(score > 500*stage){ // stage clear
      stage++; if(stage>maxStage) winGame(); else { showMessage('ステージクリア！','次のステージへ移動します'); enemies.length=0; bullets.length=0; enemyBullets.length=0; lasers.length=0; setTimeout(()=>{ placePlayer(); },500); }
    }

    updateHUD();
  }

  // draw
  function draw(){
    const r = devicePixelRatio||1; const W = canvas.width/r, H = canvas.height/r;
    ctx.clearRect(0,0,W,H);

    // background stars
    for(let i=0;i<60;i++){ ctx.fillStyle = 'rgba(255,255,255,0.02)'; ctx.fillRect((i*37)%W, (i*73 + Date.now()*0.0001*(i%5+1))%H, 1.5,1.5); }

    // player (skin)
    if(skin==='red') ctx.fillStyle='#ff6b6b'; else if(skin==='green') ctx.fillStyle='#7ef0a4'; else ctx.fillStyle='#9ef';
    ctx.fillRect(player.x, player.y, player.w, player.h);

    // bullets
    ctx.fillStyle='#fff'; bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

    // enemy bullets
    ctx.fillStyle='#f55'; enemyBullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

    // lasers
    ctx.fillStyle='rgba(0,255,255,0.18)'; lasers.forEach(l=>ctx.fillRect(l.x,l.y,l.width,l.height));

    // enemies
    enemies.forEach(e=>{ ctx.fillStyle = (e.type==='boss')?'#f0f':'#fb5'; ctx.fillRect(e.x,e.y,e.w,e.h); if(e.type==='boss'){ ctx.fillStyle='#000'; ctx.fillRect(e.x, e.y-10, e.w, 6); ctx.fillStyle='#0f0'; ctx.fillRect(e.x, e.y-10, e.w*(e.hp/(120+stage*80)), 6); } });

    // explosions
    explosions.forEach(ex=>{ const s = 8 + ex.frame*3; ctx.fillStyle = `rgba(255, ${200 - ex.frame*12}, 0, ${1-ex.frame/ex.max})`; ctx.beginPath(); ctx.arc(ex.x + ex.w/2, ex.y + ex.h/2, s,0,Math.PI*2); ctx.fill(); });

    // pause overlay
    if(paused){ ctx.fillStyle='rgba(0,0,0,0.45)'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#fff'; ctx.font='28px sans-serif'; ctx.fillText('PAUSED', W/2-60, H/2); }
  }

  // main loop
  function loop(t){ const dt = (t-last)/1000; last=t; if(running) update(dt); draw(); requestAnimationFrame(loop); }
  requestAnimationFrame(loop);

  // controls
  window.addEventListener('keydown', e=>{ if(e.key==='ArrowLeft') keys.left=true; if(e.key==='ArrowRight') keys.right=true; if(e.code==='Space') keys.fire=true; if(e.key==='Enter') start(); if(e.key.toLowerCase()==='p') paused=!paused; });
  window.addEventListener('keyup', e=>{ if(e.key==='ArrowLeft') keys.left=false; if(e.key==='ArrowRight') keys.right=false; if(e.code==='Space') keys.fire=false; });

  function start(){ if(!running){ running=true; audioCtx.resume(); playBGM(); } }
  function gameOver(){ running=false; stopBGM(); showMessage('ゲームオーバー','やり直しますか？'); }
  function winGame(){ running=false; stopBGM(); showMessage('クリア！','すべてのステージをクリアしました！'); }

  // messages
  function showMessage(title, text){ document.getElementById('messageTitle').textContent = title; document.getElementById('messageText').textContent = text; document.getElementById('messageOverlay').style.display='flex'; }
  function hideMessage(){ document.getElementById('messageOverlay').style.display='none'; }

  // UI hooks
  document.getElementById('startBtn').addEventListener('click', ()=>{ difficulty = document.getElementById('difficulty').value; skin = document.getElementById('skinSelect').value; document.getElementById('titleOverlay').style.display='none'; start(); });
  document.getElementById('closeTitle').addEventListener('click', ()=>{ document.getElementById('titleOverlay').style.display='none'; });
  document.getElementById('saveBtn').addEventListener('click', ()=>{ difficulty = document.getElementById('difficulty').value; skin = document.getElementById('skinSelect').value; bgmGain.gain.value = parseFloat(document.getElementById('bgmVol').value); seGain.gain.value = parseFloat(document.getElementById('seVol').value); saveGame(); });
  document.getElementById('openSaved').addEventListener('click', loadGame);
  document.getElementById('pauseBtn').addEventListener('click', ()=>{ paused=!paused; });
  document.getElementById('restartBtn').addEventListener('click', ()=>{ resetGame(); start(); });
  document.getElementById('resumeBtn').addEventListener('click', ()=>{ document.getElementById('titleOverlay').style.display='flex'; });
  document.getElementById('nextBtn').addEventListener('click', ()=>{ hideMessage(); start(); });
  document.getElementById('retryBtn').addEventListener('click', ()=>{ hideMessage(); resetGame(); start(); });
  document.getElementById('toTitleBtn').addEventListener('click', ()=>{ hideMessage(); document.getElementById('titleOverlay').style.display='flex'; });

  // touch
  function bindTouch(id, down, up){ const el=document.getElementById(id); el.addEventListener('touchstart', e=>{ e.preventDefault(); down(); }); el.addEventListener('touchend', e=>{ e.preventDefault(); up(); }); }
  bindTouch('leftBtn', ()=>keys.left=true, ()=>keys.left=false);
  bindTouch('rightBtn', ()=>keys.right=true, ()=>keys.right=false);
  bindTouch('fireBtn', ()=>keys.fire=true, ()=>keys.fire=false);

  // audio volume UI hooks
  document.getElementById('bgmVol').addEventListener('input', e=>{ bgmGain.gain.value = parseFloat(e.target.value); });
  document.getElementById('seVol').addEventListener('input', e=>{ seGain.gain.value = parseFloat(e.target.value); });

  // allow clicking to resume audio context (some browsers require user gesture)
  document.addEventListener('click', ()=>{ if(audioCtx.state === 'suspended') audioCtx.resume(); });

  // initialize HUD and UI
  updateHUD();
})();
</script>
</body>
</html>
