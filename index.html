<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
 <link rel="icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQoZ5nF2nh3MGMh1FdK-P-WiE6f-TJUeZJDI1QVThw-Ew&s=10" sizes="16×16" type="image/png" />  
<title>ブロックシューティング</title>
<style>
footer {
           padding: 30px;
           text-align: center;
           font-size: 0.85rem;
           color: rgba(255,255,255,0.5);
           border-top: 1px solid rgba(255,255,255,0.1);
           margin-top: 60px;
       }

:root{
  --bg1:#061426; --panel:#0b2233; --accent:#39f; --muted:#bcd;
}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),#00131a);font-family:system-ui,"Noto Sans JP",sans-serif;color:#eef}
.container{max-width:1100px;margin:12px auto;padding:12px}
.header{display:flex;justify-content:space-between;align-items:center;gap:8px}
.header .controls{display:flex;gap:8px;align-items:center}
button{background:var(--accent);color:#012;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
canvas{width:100%;height:68vh;border-radius:12px;display:block;background:#00131a;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
.hud{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
.hud .item{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;font-size:14px}
.touch-pad{display:flex;gap:10px;justify-content:center;margin-top:10px}
.pad{background:rgba(255,255,255,0.04);padding:12px 14px;border-radius:10px;font-size:18px;user-select:none}
@media(min-width:800px){.touch-pad{display:none}}
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1000}
.panel{background:linear-gradient(180deg,#071226,#081723);padding:16px;border-radius:12px;color:#fff;min-width:320px}
.row{display:flex;gap:8px;align-items:center;margin-top:8px}
.small{font-size:13px;padding:6px 8px}
.center{display:flex;flex-direction:column;align-items:center;gap:8px}
.menu-btn{padding:8px 12px;border-radius:8px;background:#ffffff11;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
#stageBanner{position:fixed;top:16%;left:50%;transform:translateX(-50%);color:#fff;font-size:32px;z-index:1100;display:none}
.footer{font-size:12px;color:#8fa; text-align:center;margin-top:8px}

/* Ensure overlay text white */
#pauseOverlay .panel, #shopOverlay .panel, #skillOverlay .panel, #titleOverlay .panel, #saveOverlay .panel { color: #fff; }

/* Simple HP bars */
.hudbar{width:160px;height:12px;border-radius:6px;background:rgba(255,255,255,0.06);overflow:hidden}
.hudbar > .fill{height:100%;width:100%;background:linear-gradient(90deg,#4ee,#06a);transition:width 0.12s linear}
.enemy-hp{height:6px;border-radius:3px;background:rgba(0,0,0,0.45);position:relative}
.enemy-hp > .e{height:100%;background:#ff6b6b;width:100%;border-radius:3px}

/* minor button tweaks on small screens */
@media(max-width:640px){
  button{padding:8px 10px;font-size:14px}
  .panel{min-width:260px}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h2>ブロックシューティング</h2>
    <div class="controls">
      <button id="titleBtn" class="ghost">Title</button>
      <button id="startBtn">Start</button>
      <button id="pauseBtn" class="small ghost">Pause</button>
      <label style="display:flex;align-items:center;gap:6px;color:#aac"><input id="autoFire" type="checkbox"> Auto</label>
    </div>
  </div>

  <canvas id="game" role="img" aria-label="シューティングゲーム"></canvas>

  <div class="hud">
    <div class="item">Score: <strong id="score">0</strong></div>
    <div class="item">HP: <strong id="life">100</strong></div>
    <div class="item">Stage: <strong id="stage">1</strong>/<span id="maxStage">6</span></div>
    <div class="item">Bomb: <strong id="bombVal">0</strong>%</div>
    <div style="margin-left:auto" class="item">音量 <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8"></div>
  </div>

  <div class="touch-pad">
    <div class="pad" id="leftBtn">◀</div>
    <div class="pad" id="fireBtn">●</div>
    <div class="pad" id="rightBtn">▶</div>
  </div>
</div>

<div id="stageBanner">STAGE 1</div>

<!-- Title / Settings Overlay -->
<div id="titleOverlay" class="overlay" style="display:none;z-index:1050">
  <div class="panel">
    <h3>タイトル / 設定</h3>
    <p>操作: ← → / Space（発射） / P（ポーズ） / Enter（開始） / B（ボム）</p>
    <div class="row">
      <label>難易度
        <select id="difficulty">
          <option value="easy">Easy</option>
          <option value="normal" selected>Normal</option>
          <option value="hard">Hard</option>
        </select>
      </label>
      <label>自機色
        <select id="skin">
          <option value="#9ef">青</option>
          <option value="#ff6b6b">赤</option>
          <option value="#7ef0a4">緑</option>
        </select>
      </label>
      <label>連射(秒)
        <input id="fireRate" type="range" min="0.04" max="0.6" step="0.02" value="0.18"><span id="frVal">0.18</span>
      </label>
    </div>

    <div class="row">
      <label>BGM <input id="bgmToggle" type="checkbox" checked></label>
      <label>SE <input id="seToggle" type="checkbox" checked></label>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="saveSettings" class="small ghost">Save</button>
      <button id="closeTitle" class="small ghost">Close</button>
      <button id="playFromTitle">Play</button>
    </div>
  </div>
</div>

<!-- Pause -->
<div id="pauseOverlay" class="overlay" style="display:none;z-index:1050">
  <div class="panel center">
    <h3>PAUSED</h3>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="resumeBtn" class="menu-btn">Resume</button>
      <button id="openShopBtn" class="menu-btn">Shop</button>
      <button id="openSkillBtn" class="menu-btn">Skill</button>
      <button id="settingsFromPause" class="menu-btn">Settings</button>
    </div>
  </div>
</div>

<!-- Shop -->
<div id="shopOverlay" class="overlay" style="display:none;z-index:1060">
  <div class="panel center">
    <h3>SHOP</h3>
    <div class="row"><button id="buyPower" class="menu-btn">Attack +1 (500)</button></div>
    <div class="row"><button id="buySpeed" class="menu-btn">Speed +1 (400)</button></div>
    <div class="row"><button id="buyMaxHp" class="menu-btn">Max HP +20 (800)</button></div>
    <div class="row"><button id="closeShop" class="menu-btn">Close</button></div>
  </div>
</div>

<!-- Skill -->
<div id="skillOverlay" class="overlay" style="display:none;z-index:1060">
  <div class="panel center">
    <h3>SKILL</h3>
    <div class="row">Bomb Gauge: <span id="bombGauge">0</span>/100</div>
    <div class="row"><button id="useBomb" class="menu-btn">Use Bomb (Clears bullets)</button></div>
    <div class="row"><button id="closeSkill" class="menu-btn">Close</button></div>
  </div>
</div>

<!-- Save overlay (game over) -->
<div id="saveOverlay" class="overlay" style="display:none;z-index:1060">
  <div class="panel">
    <h3>Game Over — Save Score</h3>
    <p>Your score: <strong id="finalScore">0</strong></p>
    <div class="row"><label>Name: <input id="playerName" maxlength="20" placeholder="名無し"></label><button id="saveScoreBtn" class="menu-btn">Save</button></div>
    <div style="text-align:right;margin-top:8px"><button id="closeSave" class="menu-btn">Close</button></div>
  </div>
</div>

<div class="footer">Saved locally (localStorage). Report console errors if any.</div>

<script>
/* ---------- Setup ---------- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function fit(){
  const r = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.max(360, rect.width) * r;
  canvas.height = Math.max(480, rect.height) * r;
  ctx.setTransform(r,0,0,r,0,0);
}
window.addEventListener('resize', () => { fit(); });
setTimeout(fit,50);

/* ---------- Audio (WebAudio BGM+SFX simple) ---------- */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();
const master = audioCtx.createGain(); master.gain.value = 0.8; master.connect(audioCtx.destination);
const musicGain = audioCtx.createGain(); musicGain.gain.value = 0.3; musicGain.connect(master);
const sfxGain = audioCtx.createGain(); sfxGain.gain.value = 0.9; sfxGain.connect(master);

document.getElementById('vol').addEventListener('input', e=> master.gain.value = parseFloat(e.target.value));

let bgmOsc = null;
let bgmRunning = true;
document.getElementById('bgmToggle').addEventListener('change', e => {
  bgmRunning = e.target.checked;
  if(!bgmRunning) stopBGM(); else startBGM();
});
let seEnabled = true;
document.getElementById('seToggle').addEventListener('change', e => seEnabled = e.target.checked);

function startBGM(){
  if(!bgmRunning) return;
  if(bgmOsc) return;
  // simple arpeggio-ish background using oscillator + gain envelope
  bgmOsc = audioCtx.createOscillator();
  bgmOsc.type = 'sine';
  bgmOsc.frequency.value = 110;
  const g = audioCtx.createGain(); g.gain.value = 0.001;
  bgmOsc.connect(g); g.connect(musicGain);
  bgmOsc.start();
  // slight volume breathing
  setInterval(()=>{ if(g) g.gain.linearRampToValueAtTime(0.02,audioCtx.currentTime+0.6); setTimeout(()=> g.gain.linearRampToValueAtTime(0.005,audioCtx.currentTime+0.8),700); }, 1300);
}
function stopBGM(){ if(bgmOsc){ try{ bgmOsc.stop(); }catch(e){} bgmOsc=null; } }
function sfx(freq, dur=0.06, type='square', gain=0.06){ if(!seEnabled) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(sfxGain); g.gain.value = gain; o.start(); o.stop(audioCtx.currentTime + dur); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur); }

/* ---------- Game state ---------- */
let running = false;
let paused = false;
let last = performance.now();

let score = 0;
let stage = 1;
const MAX_STAGE = 6;

// settings (persist)
let difficulty = localStorage.getItem('shooter_difficulty') || 'normal';
let skin = localStorage.getItem('shooter_skin') || '#9ef';
let fireRate = parseFloat(localStorage.getItem('shooter_fireRate')) || 0.18;

/* Entities & gameplay vars */
const player = { x:0, y:0, w:40, h:28, speed:320, cooldown:0, hp:100, hpMax:100, power:1 };
const keys = { left:false, right:false, fire:false };
let bullets = [], enemies = [], enemyBullets = [], lasers = [], particles = [], items = [];
let boss = null;
let spawnTimer = 0;
let bombGauge = 0;
let openedFromPause = false;

/* constants you set */
const BULLET_DAMAGE = 15; // as requested
const ENEMY_SMALL_HP = 20;
const BOSS_HP = 800;

/* helpers */
function rand(a,b){ return Math.random()*(b-a)+a; }
function placePlayer(){ const r = devicePixelRatio || 1; player.x = canvas.width / r / 2 - player.w/2; player.y = canvas.height / r - 88; }
placePlayer();

/* UI helpers */
const stageBanner = document.getElementById('stageBanner');
function showStageBanner(n){
  stageBanner.textContent = 'STAGE ' + n;
  stageBanner.style.display = 'block';
  setTimeout(()=> stageBanner.style.display='none',1400);
}

/* spawn enemy with types */
function spawnEnemy(){
  if(boss) return;
  if(enemies.length > 14) return;
  const r = devicePixelRatio || 1;
  const W = canvas.width / r;
  const t = Math.random();
  let type = 'small';
  if(t>0.88) type='big'; else if(t>0.6) type='mid';
  const w = type==='big'?64:type==='mid'?44:28;
  let speed = type==='small'?120:type==='mid'?80:40;
  if(difficulty==='easy') speed *= 0.8;
  if(difficulty==='hard') speed *= 1.4;
  const hp = type==='small'?ENEMY_SMALL_HP:type==='mid'?ENEMY_SMALL_HP*2:ENEMY_SMALL_HP*4;
  enemies.push({ x: rand(10, W-w-10), y: -50, w, h: Math.round(w*0.6), vy: speed/60, hp, hpMax: hp, type });
}

/* boss spawn */
function spawnBoss(){
  const r = devicePixelRatio || 1;
  const W = canvas.width / r;
  boss = { x: W/2, y: -220, w: 220, h: 110, hp: BOSS_HP, hpMax: BOSS_HP, timer:0, laserCooldown:0, phase:0 };
  particles.push({ x: boss.x, y: boss.y, dx:0, dy:0, age:0, life:0.5, color:'rgba(255,255,255,0.08)' });
  showStageBanner(stage + ' - BOSS');
  sfx(120,0.18,'sawtooth',0.12);
}

/* explosions and items */
function spawnExplosion(x,y,count=18){
  sfx(120,0.12,'triangle',0.08);
  for(let i=0;i<count;i++){
    particles.push({ x, y, dx: rand(-220,220), dy: rand(-260,-40), age:0, life: rand(0.4,1.2), color: `rgba(255,${120+Math.random()*120},0,1)` });
  }
  // chance to drop item
  if(Math.random() < 0.25){
    // item types: hp, score, power, speed
    const types = ['hp','score','power','speed'];
    const t = types[Math.floor(Math.random()*types.length)];
    items.push({ x, y, vx: rand(-20,20), vy: -40, type: t, life: 20 });
  }
}

/* fire */
function tryFire(){
  if(player.cooldown > 0) return;
  // fire multiple bullets based on power
  const centerX = player.x + player.w/2;
  const baseVy = -820;
  const step = Math.min(4, Math.floor(player.power)); // # of bullets spread
  const spread = Math.min(35, player.power*6);
  if(step <= 1){
    bullets.push({ x: centerX, y: player.y - 10, vy: baseVy, power: BULLET_DAMAGE, w:8, h:14 });
  } else {
    for(let i=0;i<step;i++){
      const a = (i - (step-1)/2) * (spread * Math.PI/180);
      bullets.push({ x: centerX, y: player.y - 10, vx: Math.sin(a)*220, vy: baseVy*Math.cos(a), power: BULLET_DAMAGE, w:7, h:12 });
    }
  }
  player.cooldown = fireRate;
  sfx(900,0.06,'square',0.06);
}

/* bomb */
function useBomb(){
  if(bombGauge < 100) return;
  bombGauge = 0;
  enemyBullets.length = 0;
  // damage some enemies
  enemies.forEach(e => e.hp -= 30 + player.power*10);
  spawnExplosion(player.x, player.y, 60);
}

/* boss attacks */
function bossAttack(){
  if(!boss) return;
  boss.timer += 0.016;
  if(boss.y < 80) { boss.y += 40*0.016; return; }
  boss.laserCooldown -= 0.016;

  // random spread
  if(Math.random() < 0.018 + stage*0.002){
    for(let i=-4;i<=4;i++){
      enemyBullets.push({ x: boss.x + i*14, y: boss.y + boss.h/2, vx: Math.sin(i*0.15)*(180 + stage*22), vy: Math.cos(i*0.15)*(180 + stage*22), w:8, h:10 });
    }
  }
  // radial
  if(Math.random() < 0.01 + stage*0.003){
    const bulletsNum = 16 + stage*2;
    for(let i=0;i<bulletsNum;i++){
      const a = (i / bulletsNum) * Math.PI * 2;
      enemyBullets.push({ x: boss.x, y: boss.y + boss.h/2, vx: Math.cos(a)*(120+stage*12), vy: Math.sin(a)*(120+stage*12), w:6, h:6 });
    }
  }
  // targeted salvos
  if(Math.random() < 0.014 + stage*0.003){
    const dx = (player.x + player.w/2) - boss.x;
    const dy = (player.y) - (boss.y + boss.h/2);
    const ang = Math.atan2(dy, dx);
    const sp = 280 + stage*12;
    for(let k=-2;k<=2;k++){
      enemyBullets.push({ x: boss.x + k*16, y: boss.y + boss.h/2, vx: Math.cos(ang + k*0.08)*sp, vy: Math.sin(ang + k*0.08)*sp, w:10, h:12 });
    }
  }
  // laser
  if(boss.laserCooldown <= 0 && Math.random() < 0.012 + stage*0.002){
    boss.laserCooldown = 5 - Math.min(3, stage*0.2);
    lasers.push({ x: boss.x - 6, y: boss.y + boss.h/2, width: 12, height: canvas.height, life: 1.4, damage: 12 });
    sfx(220,0.2,'sawtooth',0.09);
  }
}

/* stage progress */
function checkStageProgress(){
  const need = 1200 * stage;
  if(!boss && score >= need){
    spawnBoss();
  }
}

/* update */
function update(dt){
  if(paused) return;

  // movement
  if(keys.left) player.x -= player.speed * dt;
  if(keys.right) player.x += player.speed * dt;
  const r = devicePixelRatio || 1;
  player.x = Math.max(6, Math.min(canvas.width / r - player.w - 6, player.x));

  // firing
  if(player.cooldown > 0) player.cooldown -= dt;
  if((keys.fire || document.getElementById('autoFire').checked) && player.cooldown <= 0) tryFire();

  // update bullets
  for(let i=bullets.length-1;i>=0;i--){
    const b = bullets[i];
    b.x += (b.vx || 0) * dt;
    b.y += b.vy * dt;
    if(b.y < -80 || b.x < -200 || b.x > canvas.width + 200) bullets.splice(i,1);
  }

  // spawn normal enemies
  spawnTimer += dt;
  const spawnInterval = difficulty === 'easy' ? 0.9 : difficulty === 'hard' ? 0.45 : 0.6;
  if(!boss && spawnTimer > spawnInterval){ spawnTimer = 0; spawnEnemy(); }

  // update enemies
  for(let i=enemies.length-1;i>=0;i--){
    const e = enemies[i];
    e.y += e.vy * 60 * dt;
    // bullets -> enemy
    for(let j=bullets.length-1;j>=0;j--){
      const b = bullets[j];
      if(Math.abs((e.x+e.w/2) - b.x) < (e.w/2 + 8) && Math.abs((e.y+e.h/2) - b.y) < (e.h/2 + 8)){
        bullets.splice(j,1);
        e.hp -= b.power || BULLET_DAMAGE;
        spawnExplosion(b.x, b.y, 6);
        sfx(320,0.05,'triangle',0.06);
        if(e.hp <= 0){
          spawnExplosion(e.x + e.w/2, e.y + e.h/2, 12);
          const gained = (e.type === 'big' ? 120 : 24);
          addScore(gained);
          bombGauge = Math.min(100, bombGauge + 6);
          // drop extra item sometimes
          if(Math.random() < 0.15) {
            items.push({ x: e.x + e.w/2, y: e.y + e.h/2, vx:0, vy:-60, type:'score', life:20 });
          }
          enemies.splice(i,1);
        }
        break;
      }
    }
    // enemy -> player collide
    if(Math.abs((e.x+e.w/2) - (player.x+player.w/2)) < (e.w/2 + player.w/2) && Math.abs((e.y+e.h/2) - (player.y+player.h/2)) < (e.h/2 + player.h/2)){
      enemies.splice(i,1);
      player.hp -= 20;
      spawnExplosion(player.x + player.w/2, player.y + player.h/2, 10);
      sfx(220,0.06,'triangle',0.08);
      if(player.hp <= 0) gameOver();
    }
  }

  // boss logic & collision
  if(boss){
    bossAttack();
    for(let j=bullets.length-1;j>=0;j--){
      const b = bullets[j];
      if(Math.abs(b.x - boss.x) < boss.w/2 && Math.abs(b.y - boss.y) < boss.h/2){
        bullets.splice(j,1);
        boss.hp -= b.power || BULLET_DAMAGE;
        spawnExplosion(b.x, b.y, 4);
        sfx(200,0.03,'triangle',0.06);
        if(boss.hp <= 0){
          spawnExplosion(boss.x, boss.y, 60);
          sfx(120,0.18,'sawtooth',0.14);
          addScore(4000);
          boss = null;
          stage++;
          document.getElementById('stage').textContent = Math.min(stage, MAX_STAGE);
          showStageBanner(stage <= MAX_STAGE ? stage : 'CLEAR');
          enemies.length = 0; enemyBullets.length = 0; lasers.length = 0;
          if(stage > MAX_STAGE) winGame();
        }
        break;
      }
    }
  }

  // move enemy bullets
  for(let i=enemyBullets.length-1;i>=0;i--){
    const b = enemyBullets[i];
    b.x += (b.vx || 0) * dt;
    b.y += (b.vy || 160) * dt;
    if(b.y > canvas.height + 50 || b.y < -100 || b.x < -200 || b.x > canvas.width + 200){ enemyBullets.splice(i,1); continue; }
    if(Math.abs(b.x - (player.x + player.w/2)) < 18 && Math.abs(b.y - (player.y + player.h/2)) < 18){
      enemyBullets.splice(i,1);
      player.hp -= 10;
      spawnExplosion(player.x + player.w/2, player.y + player.h/2, 8);
      sfx(260,0.04,'triangle',0.08);
      if(player.hp <= 0) gameOver();
    }
  }

  // lasers
  for(let i=lasers.length-1;i>=0;i--){
    const l = lasers[i];
    if(Math.abs((player.x+player.w/2) - (l.x + l.width/2)) < 40 && (player.y < l.y + l.height)){
      player.hp -= l.damage || 10;
      spawnExplosion(player.x + player.w/2, player.y + player.h/2, 10);
      sfx(300,0.04,'sine',0.08);
      if(player.hp <= 0) gameOver();
    }
    l.life -= dt;
    if(l.life <= 0) lasers.splice(i,1);
  }

  // items movement & pickup
  for(let i=items.length-1;i>=0;i--){
    const it = items[i];
    it.vy += 180 * dt;
    it.x += (it.vx || 0)*dt;
    it.y += it.vy * dt;
    it.life -= dt;
    if(it.life <= 0) { items.splice(i,1); continue; }
    // pickup
    if(Math.abs(it.x - (player.x + player.w/2)) < 28 && Math.abs(it.y - (player.y + player.h/2)) < 28){
      if(it.type === 'hp'){ player.hp = Math.min(player.hpMax, player.hp + 30); addScore(20); }
      else if(it.type === 'score'){ addScore(120); }
      else if(it.type === 'power'){ player.power += 0.5; addScore(40); }
      else if(it.type === 'speed'){ player.speed += 20; addScore(30); }
      sfx(880,0.04,'square',0.08);
      items.splice(i,1);
    }
  }

  // particles
  for(let i=particles.length-1;i>=0;i--){ const p = particles[i]; p.x += p.dx * dt; p.y += p.dy * dt; p.age = (p.age || 0) + dt; if(p.age > p.life) particles.splice(i,1); }

  // charge bomb
  bombGauge = Math.min(100, bombGauge + dt*4);
  document.getElementById('bombGauge').textContent = Math.floor(bombGauge);
  document.getElementById('bombVal').textContent = Math.floor(bombGauge);

  // HUD updates
  document.getElementById('score').textContent = score;
  document.getElementById('life').textContent = Math.max(0, Math.round(player.hp));

  // check stage progress
  checkStageProgress();
}

/* draw */
function draw(){
  const r = devicePixelRatio || 1;
  const W = canvas.width / r, H = canvas.height / r;
  ctx.clearRect(0,0,W,H);

  // bg
  ctx.fillStyle = '#00131a';
  ctx.fillRect(0,0,W,H);

  // stars bg
  for(let i=0;i<30;i++){
    ctx.fillStyle = 'rgba(255,255,255,0.02)';
    ctx.fillRect((i*37)%W, (i*73)%H, 2,2);
  }

  // enemies
  enemies.forEach(e=>{
    ctx.fillStyle = e.type==='big' ? '#fb9250' : '#f55';
    ctx.fillRect(e.x, e.y, e.w, e.h);
    // enemy hp bar (A simple)
    const bw = e.w;
    const bx = e.x;
    const by = e.y - 8;
    ctx.fillStyle = 'rgba(255,255,255,0.12)';
    ctx.fillRect(bx, by, bw, 6);
    ctx.fillStyle = '#ff6b6b';
    const ratio = Math.max(0, e.hp / (e.hpMax || ENEMY_SMALL_HP));
    ctx.fillRect(bx, by, bw * ratio, 6);
  });

  // enemy bullets
  ctx.fillStyle = '#f66';
  enemyBullets.forEach(b=> ctx.fillRect(b.x-3, b.y-6, b.w||6, b.h||12));

  // lasers
  ctx.fillStyle = 'rgba(0,255,255,0.12)';
  lasers.forEach(L => ctx.fillRect(L.x, L.y, L.width, L.height));

  // items
  items.forEach(it=>{
    ctx.beginPath();
    ctx.arc(it.x, it.y, 8, 0, Math.PI*2);
    ctx.fillStyle = it.type === 'hp' ? '#6f6' : it.type==='score' ? '#ff8' : it.type==='power' ? '#9ef' : '#7ef';
    ctx.fill();
    ctx.closePath();
  });

  // player bullets
  ctx.fillStyle = '#fff';
  bullets.forEach(b=> ctx.fillRect(b.x- (b.w/2), b.y- (b.h/2), b.w||6, b.h||12));

  // particles
  particles.forEach(p=>{ ctx.globalAlpha = Math.max(0, 1 - (p.age / p.life)); ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 4, 4); ctx.globalAlpha = 1; });

  // boss
  if(boss){
    ctx.fillStyle = '#b04ff0';
    ctx.fillRect(boss.x - boss.w/2, boss.y - boss.h/2, boss.w, boss.h);
    // boss hp top
    const bw = 350, bx = W/2 - bw/2, by = 16;
    ctx.fillStyle = 'rgba(255,255,255,0.06)';
    ctx.fillRect(bx, by, bw, 12);
    ctx.fillStyle = '#ff8';
    ctx.fillRect(bx, by, bw * Math.max(0, boss.hp / boss.hpMax), 12);
  }

  // player
  ctx.fillStyle = skin;
  ctx.fillRect(player.x, player.y, player.w, player.h);
  // small top turret
  ctx.fillStyle = '#fff'; ctx.fillRect(player.x + player.w/2 - 3, player.y - 8, 6, 8);

  // player HP bar (A)
  const hpBarW = 160;
  const hpRatio = Math.max(0, player.hp / player.hpMax);
  ctx.fillStyle = 'rgba(255,255,255,0.06)';
  ctx.fillRect(12, 12, hpBarW, 10);
  ctx.fillStyle = '#4ee';
  ctx.fillRect(12, 12, hpBarW * hpRatio, 10);
  ctx.strokeStyle = 'rgba(255,255,255,0.06)';
  ctx.strokeRect(12, 12, hpBarW, 10);

  // HUD small
  ctx.fillStyle = '#fff'; ctx.font = '14px sans-serif';
  ctx.fillText('HP: ' + Math.round(player.hp), 12, 36);
  ctx.fillText('Bomb: ' + Math.round(bombGauge), 12, 56);
}

/* main loop */
let animHandle=null; function loop(ts){ const dt = Math.min(0.06, (ts - last) / 1000); last = ts; if(running && !paused) { update(dt); } draw(); animHandle=requestAnimationFrame(loop); } requestAnimationFrame(loop);

/* input */
window.addEventListener('keydown', e=>{
  if(e.key === 'ArrowLeft') keys.left = true;
  if(e.key === 'ArrowRight') keys.right = true;
  if(e.code === 'Space'){ keys.fire = true; e.preventDefault(); }
  if(e.key.toLowerCase() === 'p') { paused = !paused; document.getElementById('pauseOverlay').style.display = paused? 'flex' : 'none'; }
  if(e.key === 'Enter') startGame();
  if(e.key.toLowerCase() === 'b') { if(bombGauge >= 100) useBomb(); }
});
window.addEventListener('keyup', e=>{ if(e.key === 'ArrowLeft') keys.left = false; if(e.key === 'ArrowRight') keys.right = false; if(e.code === 'Space') keys.fire = false; });

/* touch: buttons plus drag to move */
function bindTouch(id, down, up){ const el = document.getElementById(id); el.addEventListener('touchstart', ev => { ev.preventDefault(); down(); }); el.addEventListener('touchend', ev => { ev.preventDefault(); up(); }); }
bindTouch('leftBtn', ()=> keys.left = true, ()=> keys.left = false);
bindTouch('rightBtn', ()=> keys.right = true, ()=> keys.right = false);
bindTouch('fireBtn', ()=> keys.fire = true, ()=> keys.fire = false);
/* drag move */
let dragging=false;
canvas.addEventListener('touchstart', e=>{ if(e.touches.length===1){ dragging=true; movePlayerToTouch(e.touches[0]); } });
canvas.addEventListener('touchmove', e=>{ if(dragging) movePlayerToTouch(e.touches[0]); }, {passive:false});
canvas.addEventListener('touchend', e=>{ dragging=false; });
function movePlayerToTouch(touch){
  const rect = canvas.getBoundingClientRect();
  const r = devicePixelRatio || 1;
  const x = (touch.clientX - rect.left) * (canvas.width/rect.width) / r;
  player.x = Math.max(6, Math.min(canvas.width / r - player.w - 6, x - player.w/2));
}

/* UI hooks */
document.getElementById('startBtn').addEventListener('click', ()=> startGame());
document.getElementById('pauseBtn').addEventListener('click', ()=> { paused = !paused; document.getElementById('pauseOverlay').style.display = paused? 'flex' : 'none'; });
document.getElementById('titleBtn').addEventListener('click', ()=> { openedFromPause = false; document.getElementById('titleOverlay').style.display = 'flex'; paused = true; });

document.getElementById('closeTitle').addEventListener('click', ()=> { document.getElementById('titleOverlay').style.display = 'none'; paused = false; });
document.getElementById('playFromTitle').addEventListener('click', ()=> {
  difficulty = document.getElementById('difficulty').value;
  skin = document.getElementById('skin').value;
  fireRate = parseFloat(document.getElementById('fireRate').value);
  localStorage.setItem('shooter_difficulty', difficulty);
  localStorage.setItem('shooter_skin', skin);
  localStorage.setItem('shooter_fireRate', fireRate);
  document.getElementById('titleOverlay').style.display = 'none';
  if(openedFromPause){
    openedFromPause = false;
    paused = false;
  } else {
    startGame();
  }
});
document.getElementById('saveSettings').addEventListener('click', ()=> {
  difficulty = document.getElementById('difficulty').value;
  skin = document.getElementById('skin').value;
  fireRate = parseFloat(document.getElementById('fireRate').value);
  localStorage.setItem('shooter_difficulty', difficulty);
  localStorage.setItem('shooter_skin', skin);
  localStorage.setItem('shooter_fireRate', fireRate);
  alert('Saved settings.');
});

/* Pause overlay buttons */
document.getElementById('resumeBtn').addEventListener('click', ()=> { paused = false; document.getElementById('pauseOverlay').style.display = 'none'; });
document.getElementById('settingsFromPause').addEventListener('click', ()=> { openedFromPause = true; document.getElementById('titleOverlay').style.display = 'flex'; });
document.getElementById('openShopBtn').addEventListener('click', ()=> { document.getElementById('shopOverlay').style.display = 'flex'; });
document.getElementById('openSkillBtn').addEventListener('click', ()=> { document.getElementById('skillOverlay').style.display = 'flex'; });

/* Shop logic */
document.getElementById('closeShop').addEventListener('click', ()=> { document.getElementById('shopOverlay').style.display = 'none'; });
document.getElementById('buyPower').addEventListener('click', ()=> { if(score >= 500){ addScore(-500); player.power+=1; sfx(1200,0.06,'square',0.08);} else alert('Not enough score'); });
document.getElementById('buySpeed').addEventListener('click', ()=> { if(score >= 400){ addScore(-400); player.speed += 30; sfx(1000,0.06,'square',0.08);} else alert('Not enough score'); });
document.getElementById('buyMaxHp').addEventListener('click', ()=> { if(score >= 800){ addScore(-800); player.hpMax += 20; player.hp += 20; sfx(700,0.08,'square',0.08);} else alert('Not enough score'); });

/* Skill overlay */
document.getElementById('closeSkill').addEventListener('click', ()=> { document.getElementById('skillOverlay').style.display = 'none'; });
document.getElementById('useBomb').addEventListener('click', ()=> { if(bombGauge >= 100){ useBomb(); document.getElementById('skillOverlay').style.display = 'none'; } else alert('Bomb not ready'); });

/* Save overlay */
document.getElementById('closeSave').addEventListener('click', ()=> { document.getElementById('saveOverlay').style.display = 'none'; });
document.getElementById('saveScoreBtn').addEventListener('click', ()=> {
  const name = document.getElementById('playerName').value.trim() || '名無し';
  const list = JSON.parse(localStorage.getItem('shooter_rank_v1') || '[]');
  list.push({ name, score, date: (new Date()).toLocaleString() });
  list.sort((a,b)=> b.score - a.score);
  if(list.length > 100) list.length = 100;
  localStorage.setItem('shooter_rank_v1', JSON.stringify(list));
  document.getElementById('saveOverlay').style.display = 'none';
});

/* start / gameover / win */
function startGame(){
  if(audioCtx.state === 'suspended') audioCtx.resume();
  startBGM();
  running = true; paused = false; last = performance.now();
  score = 0; stage = 1; player.hp = player.hpMax = 100; player.power = 1; bombGauge = 0;
  enemies.length = 0; enemyBullets.length = 0; bullets.length = 0; lasers.length = 0; particles.length = 0; items.length = 0; boss = null;
  placePlayer();
  showStageBanner(stage);
  document.getElementById('score').textContent = score;
  document.getElementById('stage').textContent = stage;
}

function gameOver(){
  running = false;
  stopBGM();
  document.getElementById('finalScore').textContent = score;
  document.getElementById('saveOverlay').style.display = 'flex';
}

function winGame(){ running = false; stopBGM(); setTimeout(()=> alert('All stages cleared!'), 350); }

/* score helper */
function addScore(n){ score += n; document.getElementById('score').textContent = score; }

/* Boss patterns facade */
function bossPatterns(dt){ /* compatibility placeholder */ }

/* fireRate UI */
const fr = document.getElementById('fireRate'), frVal = document.getElementById('frVal');
if(fr){ fr.value = fireRate; frVal.textContent = fireRate; fr.addEventListener('input', ()=> frVal.textContent = fr.value); }

/* resume audio on first gesture */
document.addEventListener('click', ()=>{ if(audioCtx.state === 'suspended') audioCtx.resume(); });

/* boot */
console.log('Full shooter loaded. Enjoy!');

// ensure menus visible & escape toggles pause
(function fixMenus(){
  ['pauseOverlay','shopOverlay','skillOverlay','titleOverlay','saveOverlay'].forEach(id=>{
    const el=document.getElementById(id); if(el){ el.style.display = el.style.display || 'none'; }
  });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape'){ paused=!paused; document.getElementById('pauseOverlay').style.display = paused? 'flex' : 'none'; } });
})();

</script>
</body>
</html>
